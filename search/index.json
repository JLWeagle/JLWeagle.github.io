[{"content":"前言 前一阵子给软路由折腾IPv6全局代理，配合AP实现所有连接的设备不走校园网计费流量。但是连接的每个终端无法直接访问纯IPv6网站了，原因是软路由没有给LAN口分配IPv6地址，于是开始折腾尝试解决这个问题。\n准备  网络：校园网IPv4/IPv6双栈 硬件：软路由FriendlyElec NanoPi R2S 固件：OpenWrt R21.8.6 / LuCI Master  LAN口获取IPv6地址的三种方式  IPv6穿透：将WAN口与LAN口桥接，路由器相当于交换机，连接的设备能够直接通过DHCPv6服务获取原生IPv6地址。但考虑到要使用Passwall等插件进行全局代理达到免流的效果，路由器自身需能够访问IPv6服务器，IPv6穿透这个方式行不通。 IPv6中继：中继模式可以让路由器自身与LAN口连接的终端都获取到原生的IPv6地址，使用OpenWrt中的odhcpd可以实现。通过对/etc/config/dhcp配置文件进行修改，WAN口和LAN口连接的设备均可以获取到20开头的公网IPv6地址。但是在我这边的环境配置后，LAN口连接的设备无论是DHCPv6还是SLAAC获取到的IP，都没有访问公网的权限。个人猜测是校园网认证的原因，因此只能使用第三种方式。 IPv6 NAT：网络地址转换(NAT, Network Address Translation)是为了解决IPv4地址短缺所提出的技术，普遍应用在有多台主机但只通过一个公网IP地址访问互联网的私有网络中。理论上IPv6拥有2^128 = 340,282,366,920,938,463,463,374,607,431,768,211,456个地址，不会存在短缺的情况，按理说也就并不需要使用NAT。但是仍然存在IPv6 NAT这种接入方式。这种方式配置简单，缺点是连接的设备没有公网IPv6地址，不能直接被外部设备访问。  IPv6 NAT配置步骤 WAN口设置 登录OpenWrt后台，如果网络 - 接口中已经有WAN6可以跳过这一步；没有的话添加新接口，基本设置如下表：\n   协议 DHCPv6客户端     请求IPv6地址 try   请求指定长度的IPv6前缀 自动    高级设置中勾选使用内置的IPv6管理，物理设置中选择与WAN口相同的以太适配器，防火墙设置中选择区域WAN，设置好后保存\u0026amp;应用。\nWAN6接口连接成功后，可以看到获取到了公网的IPv6地址： \rWAN6接口信息\r\nIPv6 ULA前缀设置 唯一本地地址(ULA, Unique Local Address)是IPv6地址在fc00::/7范围内的网段。OpenWrt默认的ULA设置的是fd00::/8内的地址，在fd00::/8范围内的地址和IPv4私有网段地址拥有类似的特性：不能保证它们在全球范围内是唯一的，只能在私有网络内进行路由，无法路由到外网。\n在网络 - 接口中的全局网络选项，将IPv6 ULA前缀的第一位由f改为d，例如我的前缀为dd92:770a:ba04::/48，保存\u0026amp;应用后应该可以看到LAN口信息中的IPv6地址： \rLAN接口信息\r\nLAN口设置 接下来，在网络 - 接口中修改LAN口配置，在一般配置 - 高级设置中勾选使用内置的IPv6管理，DHCP服务器 - IPv6设置如下：\n   路由通告服务 服务器模式     DHCPv6服务 服务器模式   NDP代理 已禁用   DHCPv6模式 无状态的+有状态的   总是通告默认路由 勾选    保存\u0026amp;应用一段时间后，连接的设备可以获取到IPv6地址了。\n防火墙与路由设置 打开网络 - 防火墙 - 自定义规则，添加如下一条命令来设置IPv6 NAT转发：\nip6tables -t nat -A POSTROUTING -o eth1 -j MASQUERADE\r其中，eth1是WAN的物理接口。设置好后需要点击重启防火墙。\n接下来我们需要为路由器添加默认网关，先在网络 - 诊断中使用Traceroute测一下，记录第一跳的地址，例如我这里是2001:da8:a800:2127::1。\n然后我们使用SSH连接到路由器，在终端中输入如下指令：\nroute -A inet6 add default gw 2001:da8:a800:2127::1\r其中，最后的地址要替换为刚才记录的第一跳地址。现在再查看当前的路由，可以看到如下记录： \r默认路由\r 重启网络服务，这时我们的设备应该是可以直接访问IPv6网站了。\n/etc/init.d/network restart\r路由器每次重启都会重置路由，因此在路由器每一次启动时我们都需要添加上面路由指令，我们添加如下脚本将其自动化：\nvim /etc/hotplug.d/iface/90-ipv6\r添加以下内容，其中的地址要替换为自己的默认网关地址：\n#!/bin/sh\r[ \u0026quot;$ACTION\u0026quot; = ifup ] || exit 0\rroute -A inet6 add default gw 2001:da8:a800:2127::1\r保存并给文件744可执行权限\nchmod +x /etc/hotplug.d/iface/90-ipv6\rIPv6测试 看能不能访问六维空间，蒲公英PT之类的网站，或者访问https://test-ipv6.com/ \rIPv6\r\n总结 经过一番折腾，网络内的每一个设备终于可以直接访问IPv6网站了，也可以用宿舍电脑通过IPv6地址直接远程教研室电脑了，反过来不行。端口映射留着下次再折腾吧。(￣Д￣\n","date":"2021-11-15T20:01:59+08:00","image":"/p/%E6%A0%A1%E5%9B%AD%E7%BD%91%E9%85%8D%E7%BD%AEipv6-nat/thread_weave_colorful_network_web-100728394-large_hu63eac3fc13c94bf0d92dcdcba888aee0_221005_120x120_fill_q75_box_smart1.jpg","permalink":"/p/%E6%A0%A1%E5%9B%AD%E7%BD%91%E9%85%8D%E7%BD%AEipv6-nat/","title":"校园网配置IPv6 NAT"},{"content":"前言 TeamSpeak以其游戏语音聊天功能闻名，与主流的语音软件相比，它拥有高语音质量、低延时，更少的带宽使用和提供游戏内叠加等优点。使用起来也比其它“语音电话”的方式要简洁、舒适一些。\n准备  一个装有Ubuntu 21.04系统的VPS VPS的管理员访问权限  搭建步骤 登录服务器并更新软件包 首先，使用SSH登录VPS，Windows下可以使用PuTTY等软件连接SSH：\nssh root@服务器IP地址\r检查并更新已安装的软件包：\napt-get update -y\rapt-get upgrade -y\r安装TeamSpeak服务端 添加一个单独的用户来运行TeamSpeak服务端：\nadduser --disabled-login teamspeak\r添加用户时的信息可以一路回车。创建好后，切换到TeamSpeak用户，下载最新的TeamSpeak服务端文件：\nsu - teamspeak\rwget https://files.teamspeak-services.com/releases/server/3.13.6/teamspeak3-server_linux_amd64-3.13.6.tar.bz2\r解压下载好的压缩包，移动到TeamSpeak用户目录下并删除文件夹与压缩包：\ntar xvfj teamspeak3-server_linux_amd64-3.13.6.tar.bz2\rcp teamspeak3-server_linux_amd64/* -R /home/teamspeak/\rrm -rf teamspeak3-server_linux_amd64 teamspeak3-server_linux_amd64-3.13.6.tar.bz2\r创建服务端的License文件，切换回root：\ntouch .ts3server_license_accepted\rexit\r配置TeamSpeak服务文件 接下来，创建TeamSpeak的Systemd服务文件：\nvim /lib/systemd/system/ts3server.service\r复制以下内容并保存：\n[Unit]\rDescription=Teamspeak Service\rWants=network.target\r[Service]\rWorkingDirectory=/home/teamspeak\rUser=teamspeak\rExecStart=/home/teamspeak/ts3server_minimal_runscript.sh\rExecStop=/home/teamspeak/ts3server_startscript.sh stop\rExecReload=/home/teamspeak/ts3server_startscript.sh restart\rRestart=always\rRestartSec=15\r[Install]\rWantedBy=multi-user.target\r防火墙放行语音和文件传输的端口，重启防火墙：\nufw allow 9987\rufw allow 30033\rufw reload\r重启Systemd服务，运行TeamSpeak服务端并将其设置为开机自启：\nsystemctl daemon-reload\rsystemctl start ts3server\rsystemctl enable ts3server\r查看服务端状态：\nsystemctl status ts3server\r日志中的token是语音服务器管理员权限的口令。复制下来，首次登录需要输入： \rTeamSpeak管理员口令\r 到这里，打开TeamSpeak客户端就可以正常连接了。\n注意事项 如果搭建后出现连接失败的情况，请检查相关的端口是否被防火墙放行。不同发行的Linux操作系统设置防火墙有细微的差别，有些VPS需要在控制台中进行防火墙的设置。\n","date":"2021-11-13T18:09:52+08:00","image":"/p/ubuntu-21.04-%E6%90%AD%E5%BB%BAteamspeak%E6%9C%8D%E5%8A%A1%E7%AB%AF/helena-hertz-wWZzXlDpMog-unsplash_hu45a5e3ad5e058da6a00650ed8fd40bea_15530_120x120_fill_q75_box_smart1.jpg","permalink":"/p/ubuntu-21.04-%E6%90%AD%E5%BB%BAteamspeak%E6%9C%8D%E5%8A%A1%E7%AB%AF/","title":"Ubuntu 21.04 搭建TeamSpeak服务端"}]